name: Build
env:
  SLN_PATH: Source/
on:
  workflow_dispatch:
    inputs:
      PR:
        description: PR Number
        required: true
  pull_request_target:
    branches: [ master, Development, staging ]

jobs:
  build:
    name: Build on ubuntu-latest
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    # Setup dot net
    - name: Setup Dotnet
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 3.1.x    

    # Build artifact
    - name: Building
      run: |
        dotnet restore ${{ env.SLN_PATH }}
        dotnet build ${{ env.SLN_PATH }} --configuration Debug --no-restore
    
    # Upload artifact
    - name: Upload Mod Files
      uses: actions/upload-artifact@v2
      with:
        name: combatrealism
        path: |
          About/
          Assemblies/
          Defs/
          Ideology/
          Languages/
          Media/
          Patches/
          Royalty/
          Sounds/
          Textures/
          Source/
          LoadFolders.xml

    - name: Create comment
      uses: peter-evans/create-or-update-comment@v1
      with:
        issue-number: ${{ github.event.pull_request.number }}${{ github.event.inputs.PR }}
        body: |
          You can download the built mod for this PR here in the artifacts section (at the bottom of the page): https://github.com/CombatRealism/CombatRealism/actions/runs/${{ github.run_id }}

    - name: Add Label
      uses: actions-ecosystem/action-add-labels@v1
      with:
        github_token: ${{ secrets.github_token }}
        labels: "Download in Comments"
        number: ${{ github.event.pull_request.number }}${{ github.event.inputs.PR }}
